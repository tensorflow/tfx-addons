# Prediction results to BigQuery component

[![Python](https://img.shields.io/pypi/pyversions/tfx.svg?style=plastic)](https://github.com/tensorflow/tfx)
[![TensorFlow](https://img.shields.io/badge/TFX-orange)](https://www.tensorflow.org/tfx)

## Project Description

This component exports prediction results from BulkInferrer to a BigQuery
table.
The BigQuery table schema can be generated through one of the following sources:
1. From SchemaGen component output
2. From Transform component output
3. From BulkInferrer component output (i.e. prediction results)

If both SchemaGen and Transform outputs are passed to the component,
the SchemaGen output will take priority. It would be best to use SchemaGen
for generating the BigQuery schema.

If the Transform output channel is passed to the component, without the
SchemaGen output, the BigQuery schema will be derived from the pre-transform
metadata schema generated by Transform. Note that the metadata schema may
include a label key, which may not be present in the BulkInferrer prediction
results. Therefore, this option may not work for unlabeled data.

If neither the SchemaGen nor Transform outputs are passed to the component,
the BigQuery schema will be parsed from the BulkInferrer prediction results
itself, which contains tf.Example protos.

Prediction string labels from the BulkInferrer output may be derived by passing a 'vocab_label_file' execution parameter to the component. This will only work
if the Transform component output is passed and if it the `vocab_label_file`
is present.

## Project Use-Case(s)

The main use case for this components is to enable export of model prediction
results into a BigQuery for further data analysis. The exported table will
contain the model predictions and their corresponding inputs. If the input
data is labeled, this would allow users to compare labels and corresponding predictions.

## Project Implementation

PredictionsToBigQuery component uses Beam to process the prediction results
from BulkInferrer and export it to a BigQuery table.

The BigQuery table name is passed as a parameter by the user, however the user
can also choose to have the component append a timestamp at the end of the table name.

The output component is the fully qualified BigQuery table name where the inference results are stored, and this can be accessed through the `bigquery_export` key. The same table name is also stored as a custom property
of the `bigquery_export` artifact.

### Usage example

```python

from tfx import v1 as tfx
import tfx_addons as tfxa

...

predictions_to_bigquery = tfxa.predictions_to_bigquery.PredictionsToBigQuery(
    schema=schema_gen.outputs['schema']
    transform_graph=transform.outputs['transform_graph'],
    bq_table_name='my_bigquery_table',
    gcs_temp_dir='gs://bucket/temp-dir',
    vocab_label_file='Label',
)
```

TFX pipeline examples can be found in `integration_test.py`.

For a description of the inputs and execution parameters of the component,
refer to the `component.py` file.

## Project Dependencies

See `version.py` in the top repo directory for component dependencies.

## Testing

Each Python module has a correspondin unit test file ending in `_test.py`.

An integration test is also available and requires use of a Google Cloud
project. Additional instructions for running the unit test can be found in `integration_test.py`.

Some tests use Abseil's `absltest` module.
Install the package using pip:
```bash
pip install absl-py
```

### Test coverage

Test coverage can be generated using the `coverage package`:
```bash
pip install coverage
```

To get test code coverage on the component code, run the following from the
top directory of the tfx-addons repository:

```bash
coverage run -m unittest discover -s tfx_addons/predictions_to_bigquery -p *_test.py
```

Generate a summary report in the terminal:
```bash
coverage report -m

```
Generate an HTML report that also details missed lines
```bash
coverage html -d /tmp/htmlcov
```

If working on a remote machine, the HTML coverage report can be viewed
by launching a web server
```bash
pushd /tmp/htmlcov
python -m http.server 8000  # or another unused port number
```

## Acknowledgements

This code was originally written by Hannes Hapke (Digits Financial Inc.)
on Feb. 6, 2023.
